---
description: Documents video processing pipeline stages, frame handling, and composition logic for overlaying foreground video onto background video
globs: **/*.py,**/video/*.py,**/pipeline/*.py
alwaysApply: false
---


# video-processing-pipeline

The video processing pipeline implements intelligent overlay and synchronization of foreground video onto background video through several distinct stages:

## Core Pipeline Stages

1. **Video Analysis & Metadata Extraction**
- Probes input videos using ffprobe to gather resolution, FPS, duration, frame count
- Analyzes audio stream information and determines primary audio source
- Importance Score: 75

2. **Spatial Alignment Stage**
- Extracts representative frames from video midpoints
- Uses template matching to determine optimal (x,y) overlay position
- Handles resolution mismatches through intelligent scaling
- Importance Score: 85

3. **Temporal Frame Mapping** 
- Generates frame fingerprints using perceptual hashing
- Creates frame alignment map using Dynamic Time Warping (DTW)
- Ensures foreground frames are preserved without modification
- Dynamically warps background video timing to match foreground
- Importance Score: 95

4. **Video Composition Process**
- Sequential frame reading from both video streams
- Overlays foreground frames at computed spatial position
- Applies frame blending when smooth mode is enabled
- Importance Score: 90

5. **Audio Integration**
- Prioritizes foreground audio track when available
- Synchronizes audio timing with composed video
- Falls back to background audio if needed
- Importance Score: 80

## Key Business Rules

1. **Foreground Preservation**
- All foreground frames must be included without modification
- Background video timing adapts to match foreground frames
- Importance Score: 95

2. **Synchronization Requirements** 
- Must prevent temporal drift between videos
- Alignment must be monotonic (no backwards time jumps)
- Frame mapping must be continuous and smooth
- Importance Score: 90

3. **Quality Assurance**
- Validates frame alignment confidence scores
- Ensures spatial matching exceeds minimum correlation threshold
- Verifies audio sync within acceptable tolerance
- Importance Score: 85

## Domain-Specific Components

1. **Frame Fingerprinting System**
- Combines multiple perceptual hash algorithms
- Normalized Hamming distance for fingerprint comparison
- Weighted scoring based on hash type reliability
- Importance Score: 90

2. **DTW-based Temporal Alignment**
- Cost matrix represents frame pair similarity scores
- Path constraints prevent unrealistic warping
- Interpolates between key frame matches
- Importance Score: 95

$END$